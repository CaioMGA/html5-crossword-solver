/**
Copyright (c) 2015-2017, Crossword Nexus
https://opensource.org/licenses/BSD-3-Clause
**/
!function(t,e){"object"==typeof module&&"object"==typeof module.exports?module.exports=e(t):e(t,!0)}("undefined"!=typeof window?window:this,function(t,e){"use strict";function i(t,e){var i=new XMLHttpRequest,o=$.Deferred();return i.open("GET",t),i.responseType="blob",i.onload=function(){200==i.status?s(i.response,e,o):o.reject(p)},i.send(),o}function s(t,e,i){var s=new FileReader;return i=i||$.Deferred(),s.onload=function(s){var r=s.target.result;e===h&&(r.match(/^<\?xml/)?l(s.target.result,i):o(new zip.TextReader(t),l,i))},s.readAsText(t),i}function o(t,e,i){zip.workerScripts={inflater:[u+"/z-worker.js",u+"/inflate.js"]},zip.createReader(t,function(t){t.getEntries(function(t){t.length&&t[0].getData(new zip.TextWriter,function(t){"function"==typeof e&&e(t,i)})})},function(t){i.reject(v)})}function l(e,i){var s;e=e.replace("&nbsp;"," "),t.DOMParser?s=(new DOMParser).parseFromString(e,"text/xml"):((s=new ActiveXObject("Microsoft.XMLDOM")).async=!1,s.loadXML(e)),s.getElementsByTagName("parsererror").length?i.reject(_):i.resolve(s)}function r(t){var e,i,s,o=t.childNodes,l="";for(e=0;i=o[e];e++)i.nodeType===a&&(l+=i.textContent),i.nodeType===d&&(l+="<"+(s=i.nodeName)+">"+r(i)+"</"+s+">");return l}var c,n={hover_enabled:!1,settings_enabled:!0,color_hover:"#FFFFAA",color_selected:"#FF0000",color_word:"#FFFF00",color_hilite:"#FFFCA5",color_none:"#FFFFFF",color_block:"#000000",cell_size:null,puzzle_file:null,puzzles:null,skip_filled_letters:!0,savegame_name:""},h="jpz",d=1,a=3,u="lib/zip",p="Error loading file",v="Failed to unzip file",_="Error parsing JPZ file... Not JPZ or zipped JPZ file.",g=!1,f="crossword",w=["crossword","coded"],m=0,y={createCrossword:function(t,e){var i;try{if("undefined"==typeof jQuery)throw new Error("jQuery not found");if("undefined"==typeof zip)throw new Error("Zip js not found");e&&e.hasOwnProperty("zipjs_path")&&(u=e.zipjs_path),i=new b(t,e)}catch(t){alert(t.message)}return i}},b=function(t,e){this.parent=t,this.config={};var i,s=JSON.parse(localStorage.getItem("crossword_nexus_settings"));for(i in n)n.hasOwnProperty(i)&&(s&&s.hasOwnProperty(i)?this.config[i]=s[i]:e&&e.hasOwnProperty(i)?this.config[i]=e[i]:this.config[i]=n[i]);this.cell_size=40,this.top_text_height=0,this.bottom_text_height=0,this.grid_width=0,this.grid_height=0,this.cells={},this.words={},this.clues_top=null,this.clues_bottom=null,this.active_clues=null,this.inactive_clues=null,this.hovered_x=null,this.hovered_y=null,this.selected_word=null,this.hilited_word=null,this.selected_cell=null,this.settings_open=!1,this.timer_running=!1,this.render_cells_callback=$.proxy(this.renderCells,this),this.init()};b.prototype.init=function(){var t=$.proxy(this.parseJPZPuzzle,this),e=$.proxy(this.error,this);if(this.root&&this.remove(),this.root=$('<div class="cw-main auto normal"><div class="cw-open-holder"><div class="cw-overflow"></div><div class="cw-open-puzzle"><div class="cw-text">Select puzzle</div><div class="cw-puzzles-list"></div><div class="cw-text">or</div><div class="cw-open-button"></div></div><input type="file" class="cw-open-jpz" accept="application/jpz"></div><div class="cw-notepad-icon"><span class="cwtooltip">Notepad</span></div><div class="cw-settings-icon"><span class="cwtooltip">Settings</span></div><div class="cw-settings"><div class="cw-settings-overflow"></div><div class="cw-settings-background"></div><div class="cw-option cw-color-hover"><span class="cw-option-text">Hovered</span><input class="cw-input-color" type="text"><span class="cw-color-preview"></span></div><div class="cw-option cw-color-selected"><span class="cw-option-text">Selected</span><input class="cw-input-color" type="text"><span class="cw-color-preview"></span></div><div class="cw-option cw-color-word"><span class="cw-option-text">Word</span><input class="cw-input-color" type="text"><span class="cw-color-preview"></span></div><div class="cw-option cw-color-hilite"><span class="cw-option-text">Hilite</span><input class="cw-input-color" type="text"><span class="cw-color-preview"></span></div><div class="cw-option cw-cell-size"><span class="cw-option-text">Size</span><input class="cw-input-size" type="text"><label><input type="checkbox">Auto</label></div><div class="cw-option cw-skip-filled"><label><input type="checkbox">Skip filled letters</label></div><button>Ok</button></div><div class="cw-top-text"></div><div class="cw-full-height"></div><input type="text" class="cw-hidden-input"><div class="cw-canvas"><canvas></canvas></div><div class="cw-bottom-text"></div><div class="cw-right"><div class="cw-buttons-holder"><div class="cw-button cw-file">File<div class="cw-file-buttons"><div class="cw-button cw-save">Save</div><div class="cw-button cw-load">Load</div><div class="cw-button cw-print">Print</div></div></div><div class="cw-button cw-check">Check<div class="cw-check-buttons"><div class="cw-button cw-check-letter">Letter</div><div class="cw-button cw-check-word">Word</div><div class="cw-button cw-check-puzzle">Puzzle</div></div></div><div class="cw-button cw-reveal">Reveal<div class="cw-reveal-buttons"><div class="cw-button cw-reveal-letter">Letter</div><div class="cw-button cw-reveal-word">Word</div><div class="cw-button cw-reveal-puzzle">Puzzle</div></div></div><div class="cw-button cw-timer">00:00</div></div><div class="cw-clues-holder"><div class="cw-clues cw-clues-top"><div class="cw-clues-title"></div><div class="cw-clues-items"></div></div><div class="cw-clues cw-clues-bottom"><div class="cw-clues-title"></div><div class="cw-clues-items"></div></div></div></div></div>'),this.top_text=this.root.find("div.cw-top-text"),this.bottom_text=this.root.find("div.cw-bottom-text"),this.clues_holder=this.root.find("div.cw-clues-holder"),this.clues_top_container=this.root.find("div.cw-clues-top"),this.clues_bottom_container=this.root.find("div.cw-clues-bottom"),this.canvas_holder=this.root.find("div.cw-canvas"),this.canvas=this.root.find("canvas"),this.context=this.canvas[0].getContext("2d"),this.settings_icon=this.root.find("div.cw-settings-icon"),this.settings=this.root.find("div.cw-settings"),this.config.settings_enabled?(this.settings_overflow=this.root.find("div.cw-settings-overflow"),this.settings_submit=this.root.find("div.cw-settings button")):(this.settings_icon.remove(),this.settings.remove()),this.notepad_icon=this.root.find("div.cw-notepad-icon"),this.hidden_input=this.root.find("input.cw-hidden-input"),this.reveal_button=this.root.find("div.cw-buttons-holder div.cw-reveal"),this.reveal_letter=this.root.find("div.cw-buttons-holder div.cw-reveal-letter"),this.reveal_word=this.root.find("div.cw-buttons-holder div.cw-reveal-word"),this.reveal_puzzle=this.root.find("div.cw-buttons-holder div.cw-reveal-puzzle"),this.check_button=this.root.find("div.cw-buttons-holder div.cw-check"),this.check_letter=this.root.find("div.cw-buttons-holder div.cw-check-letter"),this.check_word=this.root.find("div.cw-buttons-holder div.cw-check-word"),this.check_puzzle=this.root.find("div.cw-buttons-holder div.cw-check-puzzle"),this.file_button=this.root.find("div.cw-buttons-holder div.cw-file"),this.save_btn=this.root.find("div.cw-buttons-holder div.cw-save"),this.load_btn=this.root.find("div.cw-buttons-holder div.cw-load"),this.print_btn=this.root.find("div.cw-buttons-holder div.cw-print"),this.timer_button=this.root.find("div.cw-buttons-holder div.cw-timer"),this.config.puzzle_file&&this.config.puzzle_file.hasOwnProperty("url")&&this.config.puzzle_file.hasOwnProperty("type")){this.root.addClass("loading");var o;switch(this.config.puzzle_file.type){case h:o=t}i(this.config.puzzle_file.url,this.config.puzzle_file.type).then(o,e)}else{var l,r,c,n=this.root.find("div.cw-open-puzzle"),d=this.root.find("div.cw-puzzles-list"),a=0;if(this.config.puzzles&&this.config.puzzles.length)for(l=0;r=this.config.puzzles[l];l++)(c=$("<span>"+r.name+"</span>")).data("url",r.url),c.data("type",r.type),d.append(c),a++;a?n.delegate("div.cw-puzzles-list span","click",function(s){var o,l=$(s.currentTarget),r=l.data("url"),c=l.data("type");c===h&&(o=t),o&&i(r,c).then(o,e)}):n.addClass("empty"),this.open_button=this.root.find("div.cw-open-button"),this.file_input=this.root.find('input[type="file"]'),this.open_button.on("click",function(t){this.file_input.click()}.bind(this)),this.file_input.on("change",function(){var i=this.file_input[0].files.length?this.file_input[0].files:null;i&&s(i[0],h).then(t,e)}.bind(this))}this.root.appendTo(this.parent)},b.prototype.error=function(t){alert(t)},b.prototype.parseJPZPuzzle=function(t){var e,i,s,o,l,c;if((i=t.getElementsByTagName("rectangular-puzzle")).length){for(var n=0;n<w.length&&(f=w[n],!((e=t.getElementsByTagName(f)).length>0));n++);if(e.length)if((s=i[0].getElementsByTagName("metadata")).length){var h=t.getElementsByTagName("applet-settings");if(h.length){var d,a=0,u=[["reveal-word","div.cw-reveal-word"],["reveal-letter","div.cw-reveal-letter"],["solution","div.cw-reveal-puzzle"]],p=$();for(d=0;d<u.length;d++)if(!h[0].getElementsByTagName(u[d][0]).length){a+=1;var v=u[d][1];p=p.add(v)}p.css({display:"none"}),3==a&&$("div.cw-reveal").css({display:"none"})}if(o=s[0].getElementsByTagName("title"),l=s[0].getElementsByTagName("creator"),c=s[0].getElementsByTagName("copyright"),this.title="",this.author="",this.copyright="",o.length){this.title=r(o[0]);var g=this.title;l.length&&(this.author=r(l[0]),g+="<br>"+this.author),c.length&&(this.copyright=r(c[0]),g+="<br>"+this.copyright),this.bottom_text.html(g)}var m=s[0].getElementsByTagName("description");m=r(m[0]),this.parseJPZCrossWord(e[0],m)}else this.error(_);else this.error("Error opening file. Probably not a crossword.")}else this.error(_)},b.prototype.parseJPZCrossWord=function(t,e){var i,s,o,l,r,c=t.getElementsByTagName("grid")[0],n=c.getElementsByTagName("grid-look")[0],h=c.getElementsByTagName("cell"),d=t.getElementsByTagName("word"),a=t.getElementsByTagName("clues");for(this.grid_width=Number(c.getAttribute("width")),this.grid_height=Number(c.getAttribute("height")),this.cell_size=n.getAttribute("cell-size-in-pixels"),this.notepad=e,this.notepad||this.notepad_icon.remove(),i=0;s=h[i];i++){var u={x:Number(s.getAttribute("x")),y:Number(s.getAttribute("y")),solution:s.getAttribute("solution"),number:s.getAttribute("number"),color:s.getAttribute("background-color"),shape:s.getAttribute("background-shape"),empty:"block"===s.getAttribute("type"),letter:s.getAttribute("solve-state")};(s.getAttribute("top-bar")||s.getAttribute("bottom-bar")||s.getAttribute("left-bar")||s.getAttribute("right-bar"))&&(u.bar={top:"true"===s.getAttribute("top-bar"),bottom:"true"===s.getAttribute("bottom-bar"),left:"true"===s.getAttribute("left-bar"),right:"true"===s.getAttribute("right-bar")}),this.cells[u.x]||(this.cells[u.x]={}),this.cells[u.x][u.y]=u}for(i=0;o=d[i];i++){var p=new z(this);p.fromJPZ(o),this.words[p.id]=p}if("coded"==f){var v=new x(this,{id:"clues_top",title:"ACROSS",clues:[],words_ids:[]}),_=new x(this,{id:"clues_bottom",title:"DOWN",clues:[],words_ids:[]});for(i=0;o=d[i];i++){var g=o.getAttribute("id");o.getAttribute("x");-1==o.getAttribute("y").indexOf("-")?(v.clues.push({word:g,number:g,text:"--"}),v.words_ids.push(g)):(_.clues.push({word:g,number:g,text:"--"}),_.words_ids.push(g))}this.clues_top=v,this.clues_bottom=_,$("div.cw-right").css({display:"none"}),$("div.cw-main").css({"margin-right":"0px"})}else{if(2!==a.length)return void this.error("Wrong number of clues in jpz file");for(i=0;l=a[i];i++){var w=new x(this);w.fromJPZ(l),this.clues_top?(w.id="clues_bottom",this.clues_bottom=w):(w.id="clues_top",this.clues_top=w)}}this.changeActiveClues(),this.renderClues(this.clues_top,this.clues_top_container),this.renderClues(this.clues_bottom,this.clues_bottom_container),this.addListeners(),this.root.removeClass("loading"),this.root.addClass("loaded"),r=this.active_clues.getFirstWord(),this.setActiveWord(r),this.setActiveCell(r.getFirstCell()),this.adjustPaddings(),this.renderCells()},b.prototype.remove=function(){this.removeListeners(),this.root.remove()},b.prototype.removeGlobalListeners=function(){$(t).off("resize",this.render_cells_callback)},b.prototype.removeListeners=function(){this.removeGlobalListeners(),this.clues_holder.undelegate("div.cw-clues-items span"),this.canvas.off("mousemove click"),this.reveal_button.off("click mouseenter mouseleave"),this.reveal_letter.off("click"),this.reveal_word.off("click"),this.reveal_puzzle.off("click"),this.check_button.off("click mouseenter mouseleave"),this.check_letter.off("click"),this.check_word.off("click"),this.check_puzzle.off("click"),this.file_button.off("click mouseenter mouseleave"),this.save_btn.off("click"),this.load_btn.off("click"),this.print_btn.off("click"),this.timer_button.off("click"),this.config.settings_enabled&&(this.settings_icon.off("click"),this.settings_overflow.off("click"),this.settings_submit.off("click"),this.settings.undelegate("div.cw-option input.cw-input-color"),this.settings.undelegate("div.cw-cell-size input[type=checkbox]")),this.notepad_icon.off("click"),this.hidden_input.off("input"),this.hidden_input.off("keydown")},b.prototype.addListeners=function(){$(t).on("resize",this.render_cells_callback),this.clues_holder.delegate("div.cw-clues-items div.cw-clue","mouseenter",$.proxy(this.mouseEnteredClue,this)),this.clues_holder.delegate("div.cw-clues-items div.cw-clue","mouseleave",$.proxy(this.mouseLeftClue,this)),this.clues_holder.delegate("div.cw-clues-items div.cw-clue","click",$.proxy(this.clueClicked,this)),this.config.hover_enabled&&this.canvas.on("mousemove",$.proxy(this.mouseMoved,this)),this.canvas.on("click",$.proxy(this.mouseClicked,this)),this.reveal_button.on("click",$.proxy(this.toggleReveal,this)),this.reveal_button.on("mouseenter",$.proxy(this.openReveal,this)),this.reveal_button.on("mouseleave",$.proxy(this.closeReveal,this)),this.reveal_letter.on("click",$.proxy(this.check_reveal,this,"letter","reveal")),this.reveal_word.on("click",$.proxy(this.check_reveal,this,"word","reveal")),this.reveal_puzzle.on("click",$.proxy(this.check_reveal,this,"puzzle","reveal")),this.check_button.on("click",$.proxy(this.toggleCheck,this)),this.check_button.on("mouseenter",$.proxy(this.openCheck,this)),this.check_button.on("mouseleave",$.proxy(this.closeCheck,this)),this.check_letter.on("click",$.proxy(this.check_reveal,this,"letter","check")),this.check_word.on("click",$.proxy(this.check_reveal,this,"word","check")),this.check_puzzle.on("click",$.proxy(this.check_reveal,this,"puzzle","check")),this.file_button.on("click",$.proxy(this.toggleFile,this)),this.file_button.on("mouseenter",$.proxy(this.openFile,this)),this.file_button.on("mouseleave",$.proxy(this.closeFile,this)),this.save_btn.on("click",$.proxy(this.savePuzzle,this)),this.load_btn.on("click",$.proxy(this.loadPuzzle,this)),this.print_btn.on("click",$.proxy(this.printPuzzle,this)),this.timer_button.on("click",$.proxy(this.toggleTimer,this)),this.config.settings_enabled&&(this.settings_icon.on("click",$.proxy(this.openSettings,this)),this.settings_overflow.on("click",$.proxy(this.closeSettings,this)),this.settings_submit.on("click",$.proxy(this.saveSettings,this)),this.settings.delegate("div.cw-option input.cw-input-color","input",$.proxy(this.settingChanged,this)),this.settings.delegate("div.cw-cell-size input[type=checkbox]","change",$.proxy(this.settingSizeAuto,this))),this.notepad&&this.notepad_icon.on("click",$.proxy(this.showNotepad,this)),this.hidden_input.on("input",$.proxy(this.hiddenInputChanged,this,null)),this.hidden_input.on("keydown",$.proxy(this.keyPressed,this))},b.prototype.changeActiveClues=function(){this.active_clues&&"clues_top"===this.active_clues.id?null!==this.inactive_clues&&(this.active_clues=this.clues_bottom,this.inactive_clues=this.clues_top):(this.active_clues=this.clues_top,this.inactive_clues=this.clues_bottom)},b.prototype.getCell=function(t,e){return this.cells[t]?this.cells[t][e]:null},b.prototype.setActiveWord=function(t){t&&(this.selected_word=t,this.top_text.html(t.clue.text))},b.prototype.setActiveCell=function(t){var e,i,s=this.canvas.offset();t&&!t.empty&&(this.selected_cell=t,this.active_clues.markActive(t.x,t.y,!1),this.inactive_clues.markActive(t.x,t.y,!0),e=s.top+(t.y-1)*this.cell_size,i=s.left+(t.x-1)*this.cell_size,this.hidden_input.css({left:i,top:e}),this.hidden_input.focus())},b.prototype.renderClues=function(t,e){var i,s,o,l=e.find("div.cw-clues-title"),r=e.find("div.cw-clues-items");for(r.find("div.cw-clue").remove(),i=0;s=t.clues[i];i++)(o=$("<div>"+s.number+". "+s.text+"</div>")).data("word",s.word),o.data("number",s.number),o.data("clues",t.id),o.addClass("cw-clue"),o.addClass("word-"+s.word),r.append(o);l.html(t.title),t.clues_container=r},b.prototype.renderCells=function(){var t,e;if(this.adjustSize(),0===Number(this.config.cell_size)){var i,s;this.root.removeClass("fixed"),this.root.addClass("auto"),i=this.root.height()-(this.top_text_height+this.bottom_text_height),s=this.root.width(),this.cell_size=Math.min(Math.floor(i/this.grid_height)-1,Math.floor(s/this.grid_width)-1)}else this.root.removeClass("auto"),this.root.addClass("fixed"),this.cell_size=Number(this.config.cell_size);this.canvas[0].width=this.grid_width*this.cell_size,this.canvas[0].height=this.grid_height*this.cell_size,this.context.clearRect(0,0,this.canvas[0].width,this.canvas[0].height),this.context.fillStyle=this.config.color_block;for(t in this.cells)for(e in this.cells[t]){var o=this.cells[t][e],l=(t-1)*this.cell_size,r=(e-1)*this.cell_size;if(o.empty)this.context.fillRect(l,r,this.cell_size,this.cell_size);else{var c=o.color||this.config.color_none;this.hilited_word&&this.hilited_word.hasCell(o.x,o.y)&&(c=this.config.color_hilite),this.selected_word&&this.selected_word.hasCell(o.x,o.y)&&(c=this.config.color_word),this.config.hover_enabled&&t==this.hovered_x&&e==this.hovered_y&&(c=this.config.color_hover),this.selected_cell&&t==this.selected_cell.x&&e==this.selected_cell.y&&(c=this.config.color_selected),this.context.fillRect(l,r,this.cell_size,this.cell_size),this.context.fillStyle=c,this.context.fillRect(l+1,r+1,this.cell_size-2,this.cell_size-2),this.context.fillStyle=this.config.color_block}if("circle"===o.shape){var n=l+this.cell_size/2,h=r+this.cell_size/2,d=this.cell_size/2;this.context.beginPath(),this.context.arc(n,h,d,0,2*Math.PI,!1),this.context.stroke()}if(o.bar){var a={top:[l,r],left:[l,r],right:[l+this.cell_size,r+this.cell_size],bottom:[l+this.cell_size,r+this.cell_size]},u={top:[l+this.cell_size,r],left:[l,r+this.cell_size],right:[l+this.cell_size,r],bottom:[l,r+this.cell_size]};for(var p in o.bar)o.bar.hasOwnProperty(p)&&o.bar[p]&&(this.context.beginPath(),this.context.moveTo(a[p][0],a[p][1]),this.context.lineTo(u[p][0],u[p][1]),this.context.lineWidth=5,this.context.stroke())}o.number&&(this.context.font=this.cell_size/4+"px sans-serif",this.context.textAlign="left",this.context.textBaseline="top",this.context.fillText(o.number,l+.1*this.cell_size,r+.1*this.cell_size)),o.letter&&(this.context.font=this.cell_size/2+"px sans-serif",o.revealed&&(this.context.font="bold italic "+this.context.font),o.checked&&(this.context.beginPath(),this.context.moveTo(l,r),this.context.lineTo(l+this.cell_size,r+this.cell_size),this.context.stroke()),this.context.textAlign="center",this.context.textBaseline="middle",this.context.fillText(o.letter,l+this.cell_size/2,r+this.cell_size/2))}},b.prototype.adjustSize=function(){var t=Math.min(this.root.outerWidth(!0),1.5*this.root.outerHeight(!0));t>=700&&!this.root.hasClass("big")?(this.root.addClass("big"),this.root.removeClass("normal small tiny"),this.adjustPaddings()):t<700&&t>=580&&!this.root.hasClass("normal")?(this.root.addClass("normal"),this.root.removeClass("big small tiny"),this.adjustPaddings()):t<580&&t>=450&&!this.root.hasClass("small")?(this.root.addClass("small"),this.root.removeClass("big normal tiny"),this.adjustPaddings()):t<450&&t<450&&!this.root.hasClass("tiny")&&(this.root.addClass("tiny"),this.root.removeClass("big normal small"),this.adjustPaddings())},b.prototype.adjustPaddings=function(){this.top_text_height=this.top_text.outerHeight(!0),this.bottom_text_height=this.bottom_text.outerHeight(!0),this.canvas_holder.css({"padding-top":this.top_text_height,"padding-bottom":this.bottom_text_height})},b.prototype.mouseMoved=function(t){if(this.config.hover_enabled){var e=this.canvas.offset(),i=t.pageX-e.left,s=t.pageY-e.top,o=Math.ceil(i/this.cell_size),l=Math.ceil(s/this.cell_size);o===this.hovered_x&&l===this.hovered_y||(this.hovered_x=o,this.hovered_y=l,this.renderCells())}},b.prototype.mouseClicked=function(t){var e=this.canvas.offset(),i=t.pageX-e.left,s=t.pageY-e.top,o=Math.ceil(i/this.cell_size),l=Math.ceil(s/this.cell_size);this.selected_cell&&this.selected_cell.x==o&&this.selected_cell.y==l&&this.changeActiveClues(),this.active_clues.getMatchingWord(o,l)?this.setActiveWord(this.active_clues.getMatchingWord(o,l)):this.setActiveWord(this.inactive_clues.getMatchingWord(o,l)),this.setActiveCell(this.getCell(o,l)),this.renderCells()},b.prototype.keyPressed=function(t){if(!this.settings_open){var e=[35,36,37,38,39,40,32,46,8,9,13].indexOf(t.keyCode)>=0;switch(t.keyCode){case 35:this.moveToFirstCell(!0);break;case 36:this.moveToFirstCell(!1);break;case 37:t.shiftKey?this.skipToWord("left"):this.moveSelectionBy(-1,0);break;case 38:t.shiftKey?this.skipToWord("up"):this.moveSelectionBy(0,-1);break;case 39:t.shiftKey?this.skipToWord("right"):this.moveSelectionBy(1,0);break;case 40:t.shiftKey?this.skipToWord("down"):this.moveSelectionBy(0,1);break;case 32:if(this.selected_cell&&this.selected_word){this.selected_cell.letter="",this.selected_cell.checked=!1;var i=this.selected_word.getNextCell(this.selected_cell.x,this.selected_cell.y);this.setActiveCell(i)}this.renderCells();break;case 46:this.selected_cell&&(this.selected_cell.letter="",this.selected_cell.checked=!1),this.renderCells();break;case 8:if(this.selected_cell&&this.selected_word){this.selected_cell.letter="",this.selected_cell.checked=!1;var s=this.selected_word.getPreviousCell(this.selected_cell.x,this.selected_cell.y);this.setActiveCell(s)}this.renderCells();break;case 9:case 13:t.shiftKey?this.moveToNextWord(!0):this.moveToNextWord(!1)}e&&(t.preventDefault(),t.stopPropagation())}},b.prototype.hiddenInputChanged=function(t){var e,i=this.hidden_input.val().slice(0,1).toUpperCase();this.selected_word&&this.selected_cell&&(i?this.selected_cell.letter=i:t&&(this.selected_cell.letter=t.toUpperCase()),this.selected_cell.checked=!1,e=this.config.skip_filled_letters?this.selected_word.getFirstEmptyCell(this.selected_cell.x,this.selected_cell.y)||this.selected_word.getNextCell(this.selected_cell.x,this.selected_cell.y):this.selected_word.getNextCell(this.selected_cell.x,this.selected_cell.y),this.setActiveCell(e),this.renderCells(),this.checkIfSolved()),this.hidden_input.val("")},b.prototype.checkIfSolved=function(){var t,e,i;for(t in this.cells)for(e in this.cells[t])if(!((i=this.cells[t][e]).empty||i.letter&&i.letter==i.solution))return;this.timer_running&&(clearTimeout(c),this.timer_button.removeClass("running"),this.timer_running=!1),alert("Crossword solved! Congratulations!")},b.prototype.skipToWord=function(t){if(this.selected_cell&&this.selected_word){var e,i,s,o,l=this.selected_cell.x,r=this.selected_cell.y,c=function(t){return!(!t||t.empty||!(s=this.active_clues.getMatchingWord(t.x,t.y))||s.id===this.selected_word.id)&&(o=s.getFirstEmptyCell()||s.getFirstCell(),this.setActiveWord(s),this.setActiveCell(o),this.renderCells(),!0)}.bind(this);switch(t){case"up":for(e=r-1;e>=0;e--)if(i=this.getCell(l,e),c(i))return;break;case"down":for(e=r+1;e<=this.grid_height;e++)if(i=this.getCell(l,e),c(i))return;break;case"left":for(e=l-1;e>=0;e--)if(i=this.getCell(e,r),c(i))return;break;case"right":for(e=l+1;e<=this.grid_width;e++)if(i=this.getCell(e,r),c(i))return}}},b.prototype.moveToNextWord=function(t){if(this.selected_word){var e,i=t?this.active_clues.getPreviousWord(this.selected_word):this.active_clues.getNextWord(this.selected_word);i&&(e=i.getFirstEmptyCell()||i.getFirstCell(),this.setActiveWord(i),this.setActiveCell(e),this.renderCells())}},b.prototype.moveToFirstCell=function(t){if(this.selected_word){var e=t?this.selected_word.getLastCell():this.selected_word.getFirstCell();e&&(this.setActiveCell(e),this.renderCells())}},b.prototype.moveSelectionBy=function(t,e,i){var s,o,l;if(this.selected_cell){if(s=this.selected_cell.x+t,o=this.selected_cell.y+e,!(l=this.getCell(s,o)))return;if(l.empty)return t<0?t--:t>0?t++:e<0?e--:e>0&&e++,void this.moveSelectionBy(t,e,!0);this.selected_word.hasCell(s,o)||(this.inactive_clues.getMatchingWord(l.x,l.y)==this.inactive_clues.getMatchingWord(this.selected_cell.x,this.selected_cell.y)&&null!==this.inactive_clues.getMatchingWord(l.x,l.y)&&(this.changeActiveClues(),this.selected_cell.letter||(l=this.selected_cell)),this.setActiveWord(this.active_clues.getMatchingWord(l.x,l.y))),this.setActiveCell(l),this.renderCells()}},b.prototype.mouseEnteredClue=function(t){var e=$(t.currentTarget);this.hilited_word=this.words[e.data("word")],this.renderCells()},b.prototype.mouseLeftClue=function(){this.hilited_word=null,this.renderCells()},b.prototype.clueClicked=function(t){var e=$(t.currentTarget),i=this.words[e.data("word")],s=i.getFirstEmptyCell()||i.getFirstCell();s&&(this.setActiveWord(i),this.active_clues.id!==e.data("clues")&&this.changeActiveClues(),this.setActiveCell(s),this.renderCells())},b.prototype.showNotepad=function(){alert(this.notepad)},b.prototype.openSettings=function(){this.settings.addClass("open"),this.settings.find("div.cw-color-hover input").val(this.config.color_hover),this.settings.find("div.cw-color-hover span.cw-color-preview").css({background:this.config.color_hover}),this.settings.find("div.cw-color-selected input").val(this.config.color_selected),this.settings.find("div.cw-color-selected span.cw-color-preview").css({background:this.config.color_selected}),this.settings.find("div.cw-color-word input").val(this.config.color_word),this.settings.find("div.cw-color-word span.cw-color-preview").css({background:this.config.color_word}),this.settings.find("div.cw-color-hilite input").val(this.config.color_hilite),this.settings.find("div.cw-color-hilite span.cw-color-preview").css({background:this.config.color_hilite}),this.config.cell_size?(this.settings.find("div.cw-cell-size input[type=text]").removeAttr("disabled"),this.settings.find("div.cw-cell-size input[type=text]").val(this.config.cell_size),this.settings.find("div.cw-cell-size input[type=checkbox]").prop("checked",!1)):(this.settings.find("div.cw-cell-size input[type=text]").prop("disabled",!0),this.settings.find("div.cw-cell-size input[type=checkbox]").prop("checked",!0)),this.settings.find("div.cw-skip-filled input[type=checkbox]").prop("checked",this.config.skip_filled_letters),this.settings_open=!0},b.prototype.closeSettings=function(){localStorage.setItem("crossword_nexus_settings","{}"),this.settings.removeClass("open"),this.settings_open=!1,this.hidden_input.focus()},b.prototype.settingChanged=function(t){var e=$(t.currentTarget),i=e.val();i.match(/#[0-9a-fA-F]{6}/)&&e.siblings("span.cw-color-preview").css({background:i})},b.prototype.settingSizeAuto=function(t){var e=$(t.currentTarget),i=e.parent().siblings("input.cw-input-size");e.prop("checked")?(i.prop("disabled",!0),i.val("")):i.removeAttr("disabled")},b.prototype.saveSettings=function(t){var e;(e=this.settings.find("div.cw-color-hover input").val()).match(/#[0-9a-fA-F]{6}/)&&(this.config.color_hover=e),(e=this.settings.find("div.cw-color-selected input").val()).match(/#[0-9a-fA-F]{6}/)&&(this.config.color_selected=e),(e=this.settings.find("div.cw-color-word input").val()).match(/#[0-9a-fA-F]{6}/)&&(this.config.color_word=e),(e=this.settings.find("div.cw-color-hilite input").val()).match(/#[0-9a-fA-F]{6}/)&&(this.config.color_hilite=e),(e=this.settings.find("div.cw-cell-size input[type=checkbox]").prop("checked"))?this.config.cell_size=null:(e=this.settings.find("div.cw-cell-size input.cw-input-size").val(),this.config.cell_size=Math.max(10,Math.min(100,Number(e)))),this.config.skip_filled_letters=this.settings.find("div.cw-skip-filled input[type=checkbox]").prop("checked"),this.closeSettings(),this.renderCells(),this.hidden_input.focus(),t.preventDefault(),t.stopPropagation()},b.prototype.openReveal=function(){this.reveal_button.addClass("open")},b.prototype.closeReveal=function(){this.reveal_button.removeClass("open")},b.prototype.toggleReveal=function(){this.reveal_button.toggleClass("open")},b.prototype.openCheck=function(){this.check_button.addClass("open")},b.prototype.closeCheck=function(){this.check_button.removeClass("open")},b.prototype.toggleCheck=function(){this.check_button.toggleClass("open")},b.prototype.openFile=function(){this.file_button.addClass("open")},b.prototype.closeFile=function(){this.file_button.removeClass("open")},b.prototype.toggleFile=function(){this.file_button.toggleClass("open")},b.prototype.check_reveal=function(t,e,i){var s=[];switch(t){case"letter":this.selected_cell&&(s=[this.selected_cell]);break;case"word":if(this.selected_word){var o;for(c=0;o=this.selected_word.cells[c];c++)(r=this.selected_word.getCellByCoordinates(o))&&s.push(r)}break;case"puzzle":var l,r;for(c in this.cells)for(l in this.cells[c])r=this.cells[c][l],s.push(r)}for(var c=0;c<s.length;c++)s[c].letter!=s[c].solution&&("reveal"==e?(s[c].letter=s[c].solution,s[c].revealed=!0,s[c].checked=!1):"check"==e&&(s[c].checked=!0));this.renderCells(),"reveal"==e?(this.checkIfSolved(),this.closeReveal()):this.closeCheck(),this.hidden_input.focus(),i.preventDefault(),i.stopPropagation()},b.prototype.savePuzzle=function(t){var e,i,s={cell_size:this.cell_size,top_text_height:this.top_text_height,bottom_text_height:this.bottom_text_height,grid_width:this.grid_width,grid_height:this.grid_height,bottom_text:this.bottom_text.html(),top_clues:{id:this.clues_top.id,title:this.clues_top.title,clues:this.clues_top.clues,words_ids:this.clues_top.words_ids},bottom_clues:{id:this.clues_bottom.id,title:this.clues_bottom.title,clues:this.clues_bottom.clues,words_ids:this.clues_bottom.words_ids},words:{},cells:this.cells};for(e in this.words)this.words.hasOwnProperty(e)&&(s.words[e]={id:this.words[e].id,cell_ranges:this.words[e].cell_ranges,cells:this.words[e].cells,clue:this.words[e].clue});i="crossword_nexus_savegame"+(this.config.savegame_name||""),localStorage.setItem(i,JSON.stringify(s)),alert("Crossword saved"),this.closeFile(),t.preventDefault(),t.stopPropagation()},b.prototype.loadPuzzle=function(t){var e,i,s,o;if(i="crossword_nexus_savegame"+(this.config.savegame_name||""),(s=JSON.parse(localStorage.getItem(i)))&&s.hasOwnProperty("bottom_text")&&s.hasOwnProperty("top_clues")&&s.hasOwnProperty("bottom_clues")&&s.hasOwnProperty("words")&&s.hasOwnProperty("cells")&&s.hasOwnProperty("cell_size")&&s.hasOwnProperty("top_text_height")&&s.hasOwnProperty("bottom_text_height")&&s.hasOwnProperty("grid_width")&&s.hasOwnProperty("grid_height")){this.cell_size=s.cell_size,this.top_text_height=s.top_text_height,this.bottom_text_height=s.bottom_text_height,this.grid_width=s.grid_width,this.grid_height=s.grid_height,this.bottom_text.html(s.bottom_text),this.selected_cell=null,this.selected_word=null,this.words={};for(e in s.words)s.words.hasOwnProperty(e)&&(this.words[e]=new z(this,s.words[e]));if(this.cells=s.cells,g=!1,this.clues_top=new x(this,s.top_clues),this.clues_bottom=new x(this,s.bottom_clues),g)return void this.error("Error loading savegame - probably corrupted");this.renderClues(this.clues_top,this.clues_top_container),this.renderClues(this.clues_bottom,this.clues_bottom_container),this.active_clues=null,this.inactive_clues=null,this.changeActiveClues(),o=this.active_clues.getFirstWord(),this.setActiveWord(o),this.setActiveCell(o.getFirstCell()),this.renderCells(),alert("Crossword loaded")}else alert("No saved game found");this.closeFile(),t.preventDefault(),t.stopPropagation()},b.prototype.printPuzzle=function(t){if("undefined"!=typeof jsPDF){var e="puzzle.pdf";this.title&&(e=this.title.replace(/[^a-z0-9]/gi,"_").toLowerCase()+".pdf");var i={margin:20,title_pt:null,author_pt:null,copyright_pt:8,num_columns:null,column_padding:10,gray:.4,under_title_spacing:20,max_clue_pt:14,min_clue_pt:5,grid_padding:5,outfile:e};i.num_columns||(i.num_columns=this.grid_width>=17?4:3);var s,o=Math.max(i.title_pt,i.author_pt),l=i.margin,r=[];for(var c in this.clues_top.clues)if(this.clues_top.clues.hasOwnProperty(c)){a=(d=this.clues_top.clues[c].number.toString())+". "+(P=this.clues_top.clues[c].text);if(0==c){var n=this.clues_top.title.replace(/(<([^>]+)>)/gi,"").trim();r.push(n+"\n"+a)}else r.push(a)}r.push("");var h=[];for(var c in this.clues_bottom.clues)if(this.clues_bottom.clues.hasOwnProperty(c)){var d=this.clues_bottom.clues[c].number.toString(),a=d+". "+(P=this.clues_bottom.clues[c].text);if(0==c){var u=this.clues_bottom.title.replace(/(<([^>]+)>)/gi,"").trim();h.push(u+"\n"+a)}else h.push(a)}for(var p=(612-2*l-(i.num_columns-1)*i.column_padding)/i.num_columns,v=612-2*l-p-i.column_padding,_=612-l-v,g=792-l-v-i.copyright_pt,f=i.max_clue_pt,w=!0;w;){var m=f/3;(s=new jsPDF("portrait","pt","letter")).setFontSize(f);for(var y=l,b=l+o+i.under_title_spacing+f+m,x=0,z=[r,h],C=0;C<z.length;C++)for(var k=z[C],c=0;c<k.length;c++){var P=k[c],A=0==x?792-l-i.copyright_pt:g-i.grid_padding;b+((S=s.splitTextToSize(P,p)).length-1)*(f+m)>A&&(y=l+(x+=1)*(p+i.column_padding),b=l+o+i.under_title_spacing+f+m);for(I=0;I<S.length;I++){0==c&&0==I?s.setFontType("bold"):s.setFontType("normal");var F=S[I];s.text(y,b,F),b+=f+m}}f==i.min_clue_pt?w=!1:x>i.num_columns-1?f-=.2:w=!1}if(i.author_pt||(i.author_pt=i.title_pt),!i.title_pt){i.title_pt=12;for(var T=!0;T;){var $=this.title+"asdfasdf"+this.author;s.setFontSize(i.title_pt).setFontType("bold");var S=s.splitTextToSize($,612);1==S.length?T=!1:i.title_pt-=1}i.author_pt=i.title_pt}var N=l,O=612-l,W=l+o;s.setFontSize(i.title_pt),s.setFontType("bold"),s.text(N,W,this.title),s.setFontSize(i.author_pt),s.text(O,W,this.author,null,null,"right"),s.setFontType("normal");var B=612-l,E=792-l;s.setFontSize(i.copyright_pt),s.text(B,E,this.copyright,null,null,"right");var M={grid_letters:!0,grid_numbers:!0,x0:_,y0:g,grid_size:v,gray:i.gray},j=Math.max(this.grid_width,this.grid_height),R=M.grid_size/j;for(var L in this.cells)for(var D in this.cells[L]){var J=this.cells[L][D],c=D-1,I=L-1,Z=M.x0+I*R,H=M.y0+c*R,X=(this.grid_width,!1),K=J.letter;J.empty&&(X=!0,K=""),M.grid_letters||(K="");var G=J.number;M.grid_numbers||(G=""),function(t,e,i,s,o,l,r,c,n){var h=r?"F":"",d=s/4,a=s/1.5;if(n){var h="F",u=function(t){var e=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;t=t.replace(e,function(t,e,i,s){return e+e+i+i+s+s});var i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null}(n);t.setFillColor(u.r,u.g,u.b),t.rect(e,i,s,s,h),t.rect(e,i,s,s,"")}else t.setFillColor(M.gray.toString()),t.rect(e,i,s,s,h);o||(o=""),t.setFontSize(d),t.text(e+1,i+1+d,o),l||(l=""),t.setFontSize(a),t.text(e+s/2,i+.8*s,l,null,null,"center"),c&&t.circle(e+s/2,i+s/2,s/2)}(s,Z,H,R,G,K,X,J.shape,J.color)}s.save(i.outfile)}else alert("Printing is disabled.  jsPDF is not defined.  Contact the webmaster.")},b.prototype.toggleTimer=function(){function t(){var t=((s=((m+=1)-(i=m%60))/60)?s>9?s:"0"+s:"00")+":"+(i>9?i:"0"+i);o.html(t),e()}function e(){c=setTimeout(t,1e3)}var i,s,o=this.timer_button;this.timer_running?(clearTimeout(c),o.removeClass("running"),this.timer_running=!1,this.hidden_input.focus()):(this.timer_running=!0,o.addClass("running"),this.hidden_input.focus(),e())};var x=function(t,e){this.id="",this.title="",this.clues=[],this.clues_container=null,this.words_ids=[],this.crossword=t,e&&(e.hasOwnProperty("id")&&e.hasOwnProperty("title")&&e.hasOwnProperty("clues")&&e.hasOwnProperty("words_ids")?(this.id=e.id,this.title=e.title,this.clues=e.clues,this.words_ids=e.words_ids):g=!0)};x.prototype.fromJPZ=function(t){var e,i,s=t.getElementsByTagName("title")[0],o=t.getElementsByTagName("clue");for(this.title=r(s),e=0;i=o[e];e++){var l=i.getAttribute("word"),c=this.crossword.words[l],n={word:l,number:i.getAttribute("number"),text:r(i)};this.clues.push(n),c.clue=n,this.words_ids.push(l)}},x.prototype.getFirstWord=function(){return this.words_ids.length?this.crossword.words[this.words_ids[0]]:null},x.prototype.getMatchingWord=function(t,e){var i,s,o;for(i=0;s=this.words_ids[i];i++)if((o=this.crossword.words.hasOwnProperty(s)?this.crossword.words[s]:null)&&o.cells.indexOf(t+"-"+e)>=0)return o;return null},x.prototype.markActive=function(t,e,i){var s,o,l,r=i?"passive":"active",c=this.getMatchingWord(t,e);this.clues_container.find("div.cw-clue.active").removeClass("active"),this.clues_container.find("div.cw-clue.passive").removeClass("passive"),c&&((s=this.clues_container.find("div.cw-clue.word-"+c.id)).addClass(r),o=s.position().top,l=s.outerHeight(!0),(o<0||o+l>this.clues_container.height())&&this.clues_container.animate({scrollTop:this.clues_container.scrollTop()+o},150))},x.prototype.getNextWord=function(t){var e=null,i=this.words_ids.indexOf(t.id);return i<this.words_ids.length-1&&(e=this.crossword.words[this.words_ids[i+1]]),e},x.prototype.getPreviousWord=function(t){var e=null,i=this.words_ids.indexOf(t.id);return i>0&&(e=this.crossword.words[this.words_ids[i-1]]),e};var z=function(t,e){this.id="",this.cell_ranges=[],this.cells=[],this.clue={},this.crossword=t,e&&(e.hasOwnProperty("id")&&e.hasOwnProperty("cell_ranges")&&e.hasOwnProperty("cells")&&e.hasOwnProperty("clue")?(this.id=e.id,this.cell_ranges=e.cell_ranges,this.cells=e.cells,this.clue=e.clue):g=!0)};return z.prototype.fromJPZ=function(t){if(t){var e,i,s=t.getAttribute("id"),o=t.getAttribute("x"),l=t.getAttribute("y");if(this.id=s,o&&l)this.cell_ranges.push({x:o,y:l});else{var r=t.getElementsByTagName("cells");for(e=0;i=r[e];e++)o=i.getAttribute("x"),l=i.getAttribute("y"),this.cell_ranges.push({x:o,y:l})}this.parseRanges()}},z.prototype.parseRanges=function(){var t,e,i;for(this.cells=[],t=0;i=this.cell_ranges[t];t++){var s,o,l,r,c,n,h=i.x.split("-"),d=i.y.split("-");if(h.length>1)for(l=Number(h[0]),r=Number(h[1]),o=d[0],e=l;l<r?e<=r:e>=r;l<r?e++:e--)this.cells.push(e+"-"+o);else if(d.length>1)for(s=h[0],c=Number(d[0]),n=Number(d[1]),e=c;c<n?e<=n:e>=n;c<n?e++:e--)this.cells.push(s+"-"+e);else s=h[0],o=d[0],this.cells.push(s+"-"+o)}},z.prototype.hasCell=function(t,e){return this.cells.indexOf(t+"-"+e)>=0},z.prototype.getFirstEmptyCell=function(t,e){var i,s,o,l=0;for(t&&e&&(l=Math.max(0,this.cells.indexOf(t+"-"+e)))==this.cells.length-1&&(l=0),i=l;o=this.cells[i];i++)if((s=this.getCellByCoordinates(o))&&!s.letter)return s;if(l>0)for(i=0;i<l;i++)if((s=this.getCellByCoordinates(this.cells[i]))&&!s.letter)return s;return null},z.prototype.getFirstCell=function(){var t=null;return this.cells.length&&(t=this.getCellByCoordinates(this.cells[0])),t},z.prototype.getLastCell=function(){var t=null;return this.cells.length&&(t=this.getCellByCoordinates(this.cells[this.cells.length-1])),t},z.prototype.getNextCell=function(t,e){var i=this.cells.indexOf(t+"-"+e),s=null;return i<this.cells.length-1&&(s=this.getCellByCoordinates(this.cells[i+1])),s},z.prototype.getPreviousCell=function(t,e){var i=this.cells.indexOf(t+"-"+e),s=null;return i>0&&(s=this.getCellByCoordinates(this.cells[i-1])),s},z.prototype.getCellByCoordinates=function(t){var e,i,s,o;return e=t.split("-"),2===e.length&&(i=e[0],s=e[1],o=this.crossword.getCell(i,s))?o:null},z.prototype.solve=function(){var t,e,i;for(t=0;e=this.cells[t];t++)(i=this.getCellByCoordinates(e))&&(i.letter=i.solution)},"function"==typeof define&&define.amd&&define("CrosswordNexus",[],function(){return y}),e&&(t.CrosswordNexus=y),y});