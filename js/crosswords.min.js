/**
Copyright (c) 2015-2018, Crossword Nexus
https://opensource.org/licenses/BSD-3-Clause
**/
!function(t,e){"object"==typeof module&&"object"==typeof module.exports?module.exports=e(t):e(t,!0)}("undefined"!=typeof window?window:this,function(s,t){"use strict";var l,o={hover_enabled:!1,settings_enabled:!0,color_hover:"#FFFFAA",color_selected:"#FF0000",color_word:"#FFFF00",color_hilite:"#FFFCA5",color_none:"#FFFFFF",color_block:"#000000",cell_size:null,puzzle_file:null,puzzles:null,skip_filled_letters:!0,savegame_name:""},h="jpz",w="clues_top",m="clues_bottom",c="down",n="left",d="right",r="crossword_nexus_savegame",e="big",i="normal",a="small",u="tiny",p="undefined",v=1,_=3,g="zipjs_path",f="lib/zip",b="Failed to unzip file",y="Error parsing JPZ file... Not JPZ or zipped JPZ file.",x=!1,z="crossword",C=["crossword","coded"],k=0;function P(t,e){var i=new XMLHttpRequest,s=$.Deferred();return i.open("GET",t),i.responseType="blob",i.onload=function(){200==i.status?A(i.response,e,s):s.reject("Error loading file")},i.send(),s}function A(l,r,c){var t=new FileReader;return c=c||$.Deferred(),t.onload=function(t){var e,i,s,o=t.target.result;r===h&&(o.match(/^<\?xml/)?F(t.target.result,c):(e=new zip.TextReader(l),i=F,s=c,zip.workerScripts={inflater:[f+"/z-worker.js",f+"/inflate.js"]},zip.createReader(e,function(t){t.getEntries(function(t){t.length&&t[0].getData(new zip.TextWriter,function(t){"function"==typeof i&&i(t,s)})})},function(t){s.reject(b)})))},t.readAsText(l),c}function F(t,e){var i;t=t.replace("&nbsp;"," "),s.DOMParser?i=(new DOMParser).parseFromString(t,"text/xml"):((i=new ActiveXObject("Microsoft.XMLDOM")).async=!1,i.loadXML(t)),i.getElementsByTagName("parsererror").length?e.reject(y):e.resolve(i)}function T(t){var e,i,s,o=t.childNodes,l="";for(e=0;i=o[e];e++)i.nodeType===_&&(l+=i.textContent),i.nodeType===v&&(l+="<"+(s=i.nodeName)+">"+T(i)+"</"+s+">");return l}function S(t){return null==t?null:t.charAt(0)}var N={createCrossword:function(t,e){var i;try{if(typeof jQuery===p)throw new Error("jQuery not found");if(typeof zip===p)throw new Error("Zip js not found");e&&e.hasOwnProperty(g)&&(f=e[g]),i=new O(t,e)}catch(t){alert(t.message)}return i}},O=function(t,e){this.parent=t,this.config={};var i,s=JSON.parse(localStorage.getItem("crossword_nexus_settings"));for(i in o)o.hasOwnProperty(i)&&(s&&s.hasOwnProperty(i)?this.config[i]=s[i]:e&&e.hasOwnProperty(i)?this.config[i]=e[i]:this.config[i]=o[i]);this.cell_size=40,this.top_text_height=0,this.bottom_text_height=0,this.grid_width=0,this.grid_height=0,this.cells={},this.words={},this.clues_top=null,this.clues_bottom=null,this.active_clues=null,this.inactive_clues=null,this.hovered_x=null,this.hovered_y=null,this.selected_word=null,this.hilited_word=null,this.selected_cell=null,this.settings_open=!1,this.timer_running=!1,this.render_cells_callback=$.proxy(this.renderCells,this),this.init()};O.prototype.init=function(){var l=$.proxy(this.parseJPZPuzzle,this),r=$.proxy(this.error,this);if(this.root&&this.remove(),this.root=$('<div class="cw-main auto normal"><div class="cw-open-holder"><div class="cw-overflow"></div><div class="cw-open-puzzle"><div class="cw-text">Select puzzle</div><div class="cw-puzzles-list"></div><div class="cw-text">or</div><div class="cw-open-button"></div></div><input type="file" class="cw-open-jpz" accept="application/jpz"></div><div class="cw-notepad-icon"><span class="cwtooltip">Notepad</span></div><div class="cw-settings-icon"><span class="cwtooltip">Settings</span></div><div class="cw-settings"><div class="cw-settings-overflow"></div><div class="cw-settings-background"></div><div class="cw-option cw-color-hover"><span class="cw-option-text">Hovered</span><input class="cw-input-color" type="text"><span class="cw-color-preview"></span></div><div class="cw-option cw-color-selected"><span class="cw-option-text">Selected</span><input class="cw-input-color" type="text"><span class="cw-color-preview"></span></div><div class="cw-option cw-color-word"><span class="cw-option-text">Word</span><input class="cw-input-color" type="text"><span class="cw-color-preview"></span></div><div class="cw-option cw-color-hilite"><span class="cw-option-text">Hilite</span><input class="cw-input-color" type="text"><span class="cw-color-preview"></span></div><div class="cw-option cw-cell-size"><span class="cw-option-text">Size</span><input class="cw-input-size" type="text"><label><input type="checkbox">Auto</label></div><div class="cw-option cw-skip-filled"><label><input type="checkbox">Skip filled letters</label></div><button>Ok</button></div><div class="cw-top-text"></div><div class="cw-full-height"></div><input type="text" class="cw-hidden-input"><div class="cw-canvas"><canvas></canvas></div><div class="cw-bottom-text"></div><div class="cw-right"><div class="cw-buttons-holder"><div class="cw-button cw-file">File<div class="cw-file-buttons"><div class="cw-button cw-save">Save</div><div class="cw-button cw-load">Load</div><div class="cw-button cw-print">Print</div></div></div><div class="cw-button cw-check">Check<div class="cw-check-buttons"><div class="cw-button cw-check-letter">Letter</div><div class="cw-button cw-check-word">Word</div><div class="cw-button cw-check-puzzle">Puzzle</div></div></div><div class="cw-button cw-reveal">Reveal<div class="cw-reveal-buttons"><div class="cw-button cw-reveal-letter">Letter</div><div class="cw-button cw-reveal-word">Word</div><div class="cw-button cw-reveal-puzzle">Puzzle</div></div></div><div class="cw-button cw-timer">00:00</div></div><div class="cw-clues-holder"><div class="cw-clues cw-clues-top"><div class="cw-clues-title"></div><div class="cw-clues-items"></div></div><div class="cw-clues cw-clues-bottom"><div class="cw-clues-title"></div><div class="cw-clues-items"></div></div></div></div></div>'),this.top_text=this.root.find("div.cw-top-text"),this.bottom_text=this.root.find("div.cw-bottom-text"),this.clues_holder=this.root.find("div.cw-clues-holder"),this.clues_top_container=this.root.find("div.cw-clues-top"),this.clues_bottom_container=this.root.find("div.cw-clues-bottom"),this.canvas_holder=this.root.find("div.cw-canvas"),this.canvas=this.root.find("canvas"),this.context=this.canvas[0].getContext("2d"),this.settings_icon=this.root.find("div.cw-settings-icon"),this.settings=this.root.find("div.cw-settings"),this.config.settings_enabled?(this.settings_overflow=this.root.find("div.cw-settings-overflow"),this.settings_submit=this.root.find("div.cw-settings button")):(this.settings_icon.remove(),this.settings.remove()),this.notepad_icon=this.root.find("div.cw-notepad-icon"),this.hidden_input=this.root.find("input.cw-hidden-input"),this.reveal_button=this.root.find("div.cw-buttons-holder div.cw-reveal"),this.reveal_letter=this.root.find("div.cw-buttons-holder div.cw-reveal-letter"),this.reveal_word=this.root.find("div.cw-buttons-holder div.cw-reveal-word"),this.reveal_puzzle=this.root.find("div.cw-buttons-holder div.cw-reveal-puzzle"),this.check_button=this.root.find("div.cw-buttons-holder div.cw-check"),this.check_letter=this.root.find("div.cw-buttons-holder div.cw-check-letter"),this.check_word=this.root.find("div.cw-buttons-holder div.cw-check-word"),this.check_puzzle=this.root.find("div.cw-buttons-holder div.cw-check-puzzle"),this.file_button=this.root.find("div.cw-buttons-holder div.cw-file"),this.save_btn=this.root.find("div.cw-buttons-holder div.cw-save"),this.load_btn=this.root.find("div.cw-buttons-holder div.cw-load"),this.print_btn=this.root.find("div.cw-buttons-holder div.cw-print"),this.timer_button=this.root.find("div.cw-buttons-holder div.cw-timer"),this.config.puzzle_file&&this.config.puzzle_file.hasOwnProperty("url")&&this.config.puzzle_file.hasOwnProperty("type")){var t;switch(this.root.addClass("loading"),this.config.puzzle_file.type){case h:t=l}P(this.config.puzzle_file.url,this.config.puzzle_file.type).then(t,r)}else{var e,i,s,o=this.root.find("div.cw-open-puzzle"),c=this.root.find("div.cw-puzzles-list"),n=0;if(this.config.puzzles&&this.config.puzzles.length)for(e=0;i=this.config.puzzles[e];e++)(s=$("<span>"+i.name+"</span>")).data("url",i.url),s.data("type",i.type),c.append(s),n++;n?o.delegate("div.cw-puzzles-list span","click",function(t){var e,i=$(t.currentTarget),s=i.data("url"),o=i.data("type");o===h&&(e=l),e&&P(s,o).then(e,r)}):o.addClass("empty"),this.open_button=this.root.find("div.cw-open-button"),this.file_input=this.root.find('input[type="file"]'),this.open_button.on("click",function(t){this.file_input.click()}.bind(this)),this.file_input.on("change",function(){var t=this.file_input[0].files.length?this.file_input[0].files:null;t&&A(t[0],h).then(l,r)}.bind(this))}this.root.appendTo(this.parent)},O.prototype.error=function(t){alert(t)},O.prototype.parseJPZPuzzle=function(t){var e,i,s,o,l,r;if((i=t.getElementsByTagName("rectangular-puzzle")).length){for(var c=0;c<C.length&&(z=C[c],!(0<(e=t.getElementsByTagName(z)).length));c++);if(e.length)if((s=i[0].getElementsByTagName("metadata")).length){var n=t.getElementsByTagName("applet-settings");if(n.length){var h,d=0,a=[["reveal-word","div.cw-reveal-word"],["reveal-letter","div.cw-reveal-letter"],["solution","div.cw-reveal-puzzle"]],u=$();for(h=0;h<a.length;h++){if(!n[0].getElementsByTagName(a[h][0]).length){d+=1;var p=a[h][1];u=u.add(p)}}u.css({display:"none"}),3==d&&$("div.cw-reveal").css({display:"none"})}if(o=s[0].getElementsByTagName("title"),l=s[0].getElementsByTagName("creator"),r=s[0].getElementsByTagName("copyright"),this.title="",this.author="",this.copyright="",o.length){this.title=T(o[0]);var v=this.title;l.length&&(this.author=T(l[0]),v+="<br>"+this.author),r.length&&(this.copyright=T(r[0]),v+="<br>"+this.copyright),this.bottom_text.html(v)}var _=s[0].getElementsByTagName("description");_=T(_[0]),this.parseJPZCrossWord(e[0],_)}else this.error(y);else this.error("Error opening file. Probably not a crossword.")}else this.error(y)},O.prototype.parseJPZCrossWord=function(t,e){var i,s,o,l,r,c=t.getElementsByTagName("grid")[0],n=c.getElementsByTagName("grid-look")[0],h=c.getElementsByTagName("cell"),d=t.getElementsByTagName("word"),a=t.getElementsByTagName("clues");for(this.grid_width=Number(c.getAttribute("width")),this.grid_height=Number(c.getAttribute("height")),this.cell_size=n.getAttribute("cell-size-in-pixels"),this.notepad=e,this.notepad||this.notepad_icon.remove(),i=0;s=h[i];i++){var u={x:Number(s.getAttribute("x")),y:Number(s.getAttribute("y")),solution:s.getAttribute("solution"),number:s.getAttribute("number"),color:s.getAttribute("background-color"),shape:s.getAttribute("background-shape"),empty:"block"===s.getAttribute("type"),letter:s.getAttribute("solve-state")};(s.getAttribute("top-bar")||s.getAttribute("bottom-bar")||s.getAttribute("left-bar")||s.getAttribute("right-bar"))&&(u.bar={top:"true"===s.getAttribute("top-bar"),bottom:"true"===s.getAttribute("bottom-bar"),left:"true"===s.getAttribute("left-bar"),right:"true"===s.getAttribute("right-bar")}),this.cells[u.x]||(this.cells[u.x]={}),this.cells[u.x][u.y]=u}for(i=0;o=d[i];i++){var p=new B(this);p.fromJPZ(o),this.words[p.id]=p}if("coded"==z){var v=new W(this,{id:w,title:"ACROSS",clues:[],words_ids:[]}),_=new W(this,{id:m,title:"DOWN",clues:[],words_ids:[]});for(i=0;o=d[i];i++){var g=o.getAttribute("id");o.getAttribute("x");-1==o.getAttribute("y").indexOf("-")?(v.clues.push({word:g,number:g,text:"--"}),v.words_ids.push(g)):(_.clues.push({word:g,number:g,text:"--"}),_.words_ids.push(g))}this.clues_top=v,this.clues_bottom=_,$("div.cw-right").css({display:"none"}),$("div.cw-main").css({"margin-right":"0px"})}else{if(2!==a.length)return void this.error("Wrong number of clues in jpz file");for(i=0;l=a[i];i++){var f=new W(this);f.fromJPZ(l),this.clues_top?(f.id=m,this.clues_bottom=f):(f.id=w,this.clues_top=f)}}this.changeActiveClues(),this.renderClues(this.clues_top,this.clues_top_container),this.renderClues(this.clues_bottom,this.clues_bottom_container),this.addListeners(),this.root.removeClass("loading"),this.root.addClass("loaded"),r=this.active_clues.getFirstWord(),this.setActiveWord(r),this.setActiveCell(r.getFirstCell()),this.adjustPaddings(),this.renderCells()},O.prototype.remove=function(){this.removeListeners(),this.root.remove()},O.prototype.removeGlobalListeners=function(){$(s).off("resize",this.render_cells_callback)},O.prototype.removeListeners=function(){this.removeGlobalListeners(),this.clues_holder.undelegate("div.cw-clues-items span"),this.canvas.off("mousemove click"),this.reveal_button.off("click mouseenter mouseleave"),this.reveal_letter.off("click"),this.reveal_word.off("click"),this.reveal_puzzle.off("click"),this.check_button.off("click mouseenter mouseleave"),this.check_letter.off("click"),this.check_word.off("click"),this.check_puzzle.off("click"),this.file_button.off("click mouseenter mouseleave"),this.save_btn.off("click"),this.load_btn.off("click"),this.print_btn.off("click"),this.timer_button.off("click"),this.config.settings_enabled&&(this.settings_icon.off("click"),this.settings_overflow.off("click"),this.settings_submit.off("click"),this.settings.undelegate("div.cw-option input.cw-input-color"),this.settings.undelegate("div.cw-cell-size input[type=checkbox]")),this.notepad_icon.off("click"),this.hidden_input.off("input"),this.hidden_input.off("keydown")},O.prototype.addListeners=function(){$(s).on("resize",this.render_cells_callback),this.clues_holder.delegate("div.cw-clues-items div.cw-clue","mouseenter",$.proxy(this.mouseEnteredClue,this)),this.clues_holder.delegate("div.cw-clues-items div.cw-clue","mouseleave",$.proxy(this.mouseLeftClue,this)),this.clues_holder.delegate("div.cw-clues-items div.cw-clue","click",$.proxy(this.clueClicked,this)),this.config.hover_enabled&&this.canvas.on("mousemove",$.proxy(this.mouseMoved,this)),this.canvas.on("click",$.proxy(this.mouseClicked,this)),this.reveal_button.on("click",$.proxy(this.toggleReveal,this)),this.reveal_button.on("mouseenter",$.proxy(this.openReveal,this)),this.reveal_button.on("mouseleave",$.proxy(this.closeReveal,this)),this.reveal_letter.on("click",$.proxy(this.check_reveal,this,"letter","reveal")),this.reveal_word.on("click",$.proxy(this.check_reveal,this,"word","reveal")),this.reveal_puzzle.on("click",$.proxy(this.check_reveal,this,"puzzle","reveal")),this.check_button.on("click",$.proxy(this.toggleCheck,this)),this.check_button.on("mouseenter",$.proxy(this.openCheck,this)),this.check_button.on("mouseleave",$.proxy(this.closeCheck,this)),this.check_letter.on("click",$.proxy(this.check_reveal,this,"letter","check")),this.check_word.on("click",$.proxy(this.check_reveal,this,"word","check")),this.check_puzzle.on("click",$.proxy(this.check_reveal,this,"puzzle","check")),this.file_button.on("click",$.proxy(this.toggleFile,this)),this.file_button.on("mouseenter",$.proxy(this.openFile,this)),this.file_button.on("mouseleave",$.proxy(this.closeFile,this)),this.save_btn.on("click",$.proxy(this.savePuzzle,this)),this.load_btn.on("click",$.proxy(this.loadPuzzle,this)),this.print_btn.on("click",$.proxy(this.printPuzzle,this)),this.timer_button.on("click",$.proxy(this.toggleTimer,this)),this.config.settings_enabled&&(this.settings_icon.on("click",$.proxy(this.openSettings,this)),this.settings_overflow.on("click",$.proxy(this.closeSettings,this)),this.settings_submit.on("click",$.proxy(this.saveSettings,this)),this.settings.delegate("div.cw-option input.cw-input-color","input",$.proxy(this.settingChanged,this)),this.settings.delegate("div.cw-cell-size input[type=checkbox]","change",$.proxy(this.settingSizeAuto,this))),this.notepad&&this.notepad_icon.on("click",$.proxy(this.showNotepad,this)),this.hidden_input.on("input",$.proxy(this.hiddenInputChanged,this,null)),this.hidden_input.on("keydown",$.proxy(this.keyPressed,this))},O.prototype.changeActiveClues=function(){this.active_clues&&this.active_clues.id===w?null!==this.inactive_clues&&(this.active_clues=this.clues_bottom,this.inactive_clues=this.clues_top):(this.active_clues=this.clues_top,this.inactive_clues=this.clues_bottom)},O.prototype.getCell=function(t,e){return this.cells[t]?this.cells[t][e]:null},O.prototype.setActiveWord=function(t){t&&(this.selected_word=t,this.top_text.html(t.clue.text))},O.prototype.setActiveCell=function(t){var e,i,s=this.canvas.offset();t&&!t.empty&&(this.selected_cell=t,this.active_clues.markActive(t.x,t.y,!1),this.inactive_clues.markActive(t.x,t.y,!0),e=s.top+(t.y-1)*this.cell_size,i=s.left+(t.x-1)*this.cell_size,this.hidden_input.css({left:i,top:e}),this.hidden_input.focus())},O.prototype.renderClues=function(t,e){var i,s,o,l=e.find("div.cw-clues-title"),r=e.find("div.cw-clues-items");for(r.find("div.cw-clue").remove(),i=0;s=t.clues[i];i++)(o=$("<div>"+s.number+". "+s.text+"</div>")).data("word",s.word),o.data("number",s.number),o.data("clues",t.id),o.addClass("cw-clue"),o.addClass("word-"+s.word),r.append(o);l.html(t.title),t.clues_container=r},O.prototype.renderCells=function(){var t,e,i,s;(this.adjustSize(),0===Number(this.config.cell_size))?(this.root.removeClass("fixed"),this.root.addClass("auto"),i=this.root.height()-(this.top_text_height+this.bottom_text_height),s=this.root.width(),this.cell_size=Math.min(Math.floor(i/this.grid_height)-1,Math.floor(s/this.grid_width)-1)):(this.root.removeClass("auto"),this.root.addClass("fixed"),this.cell_size=Number(this.config.cell_size));for(t in this.canvas[0].width=this.grid_width*this.cell_size,this.canvas[0].height=this.grid_height*this.cell_size,this.context.clearRect(0,0,this.canvas[0].width,this.canvas[0].height),this.context.fillStyle=this.config.color_block,this.cells)for(e in this.cells[t]){var o=this.cells[t][e],l=(t-1)*this.cell_size,r=(e-1)*this.cell_size;if(o.empty)this.context.fillRect(l,r,this.cell_size,this.cell_size);else{var c=o.color||this.config.color_none;this.hilited_word&&this.hilited_word.hasCell(o.x,o.y)&&(c=this.config.color_hilite),this.selected_word&&this.selected_word.hasCell(o.x,o.y)&&(c=this.config.color_word),this.config.hover_enabled&&t==this.hovered_x&&e==this.hovered_y&&(c=this.config.color_hover),this.selected_cell&&t==this.selected_cell.x&&e==this.selected_cell.y&&(c=this.config.color_selected),this.context.fillRect(l,r,this.cell_size,this.cell_size),this.context.fillStyle=c,this.context.fillRect(l+1,r+1,this.cell_size-2,this.cell_size-2),this.context.fillStyle=this.config.color_block}if("circle"===o.shape){var n=l+this.cell_size/2,h=r+this.cell_size/2,d=this.cell_size/2;this.context.beginPath(),this.context.arc(n,h,d,0,2*Math.PI,!1),this.context.stroke()}if(o.bar){var a={top:[l,r],left:[l,r],right:[l+this.cell_size,r+this.cell_size],bottom:[l+this.cell_size,r+this.cell_size]},u={top:[l+this.cell_size,r],left:[l,r+this.cell_size],right:[l+this.cell_size,r],bottom:[l,r+this.cell_size]};for(var p in o.bar)o.bar.hasOwnProperty(p)&&o.bar[p]&&(this.context.beginPath(),this.context.moveTo(a[p][0],a[p][1]),this.context.lineTo(u[p][0],u[p][1]),this.context.lineWidth=5,this.context.stroke(),this.context.lineWidth=1)}if(o.number&&(this.context.font=this.cell_size/4+"px sans-serif",this.context.textAlign="left",this.context.textBaseline="top",this.context.fillText(o.number,l+.1*this.cell_size,r+.1*this.cell_size)),o.letter){var v=o.letter.length;this.context.font=this.cell_size/(1.5+.5*v)+"px sans-serif",o.revealed&&(this.context.font="bold italic "+this.context.font),o.checked&&(this.context.beginPath(),this.context.moveTo(l,r),this.context.lineTo(l+this.cell_size,r+this.cell_size),this.context.stroke()),this.context.textAlign="center",this.context.textBaseline="middle",this.context.fillText(o.letter,l+this.cell_size/2,r+this.cell_size/2)}}},O.prototype.adjustSize=function(){var t=Math.min(this.root.outerWidth(!0),1.5*this.root.outerHeight(!0));700<=t&&!this.root.hasClass(e)?(this.root.addClass(e),this.root.removeClass(i+" "+a+" "+u),this.adjustPaddings()):t<700&&580<=t&&!this.root.hasClass(i)?(this.root.addClass(i),this.root.removeClass(e+" "+a+" "+u),this.adjustPaddings()):t<580&&450<=t&&!this.root.hasClass(a)?(this.root.addClass(a),this.root.removeClass(e+" "+i+" "+u),this.adjustPaddings()):t<450&&t<450&&!this.root.hasClass(u)&&(this.root.addClass(u),this.root.removeClass(e+" "+i+" "+a),this.adjustPaddings())},O.prototype.adjustPaddings=function(){this.top_text_height=this.top_text.outerHeight(!0),this.bottom_text_height=this.bottom_text.outerHeight(!0),this.canvas_holder.css({"padding-top":this.top_text_height,"padding-bottom":this.bottom_text_height})},O.prototype.mouseMoved=function(t){if(this.config.hover_enabled){var e=this.canvas.offset(),i=t.pageX-e.left,s=t.pageY-e.top,o=Math.ceil(i/this.cell_size),l=Math.ceil(s/this.cell_size);o===this.hovered_x&&l===this.hovered_y||(this.hovered_x=o,this.hovered_y=l,this.renderCells())}},O.prototype.mouseClicked=function(t){var e=this.canvas.offset(),i=t.pageX-e.left,s=t.pageY-e.top,o=Math.ceil(i/this.cell_size),l=Math.ceil(s/this.cell_size);this.selected_cell&&this.selected_cell.x==o&&this.selected_cell.y==l&&this.changeActiveClues(),this.active_clues.getMatchingWord(o,l)?this.setActiveWord(this.active_clues.getMatchingWord(o,l)):this.setActiveWord(this.inactive_clues.getMatchingWord(o,l)),this.setActiveCell(this.getCell(o,l)),this.renderCells()},O.prototype.keyPressed=function(t){if(!this.settings_open){var e=0<=[35,36,37,38,39,40,32,46,8,9,13].indexOf(t.keyCode);switch(t.keyCode){case 35:this.moveToFirstCell(!0);break;case 36:this.moveToFirstCell(!1);break;case 37:t.shiftKey?this.skipToWord(n):this.moveSelectionBy(-1,0);break;case 38:t.shiftKey?this.skipToWord("up"):this.moveSelectionBy(0,-1);break;case 39:t.shiftKey?this.skipToWord(d):this.moveSelectionBy(1,0);break;case 40:t.shiftKey?this.skipToWord(c):this.moveSelectionBy(0,1);break;case 32:if(this.selected_cell&&this.selected_word){this.selected_cell.letter="",this.selected_cell.checked=!1;var i=this.selected_word.getNextCell(this.selected_cell.x,this.selected_cell.y);this.setActiveCell(i)}this.renderCells();break;case 27:case 45:if(this.selected_cell&&this.selected_word){var s=prompt("Rebus entry","");this.hiddenInputChanged(s)}break;case 46:this.selected_cell&&(this.selected_cell.letter="",this.selected_cell.checked=!1),this.renderCells();break;case 8:if(this.selected_cell&&this.selected_word){this.selected_cell.letter="",this.selected_cell.checked=!1;var o=this.selected_word.getPreviousCell(this.selected_cell.x,this.selected_cell.y);this.setActiveCell(o)}this.renderCells();break;case 9:case 13:t.shiftKey?this.moveToNextWord(!0):this.moveToNextWord(!1)}e&&(t.preventDefault(),t.stopPropagation())}},O.prototype.hiddenInputChanged=function(t){var e,i=this.hidden_input.val().slice(0,1).toUpperCase();this.selected_word&&this.selected_cell&&(i?this.selected_cell.letter=i:t&&(this.selected_cell.letter=t.toUpperCase()),this.selected_cell.checked=!1,e=this.config.skip_filled_letters&&this.selected_word.getFirstEmptyCell(this.selected_cell.x,this.selected_cell.y)||this.selected_word.getNextCell(this.selected_cell.x,this.selected_cell.y),this.setActiveCell(e),this.renderCells(),this.checkIfSolved()),this.hidden_input.val("")},O.prototype.checkIfSolved=function(){var t,e,i;for(t in this.cells)for(e in this.cells[t])if(!((i=this.cells[t][e]).empty||i.letter&&S(i.letter)==S(i.solution)))return;this.timer_running&&(clearTimeout(l),this.timer_button.removeClass("running"),this.timer_running=!1),alert("Crossword solved! Congratulations!")},O.prototype.skipToWord=function(t){if(this.selected_cell&&this.selected_word){var e,i,s,o=this.selected_cell.x,l=this.selected_cell.y,r=function(t){return!(!t||t.empty||!(i=this.active_clues.getMatchingWord(t.x,t.y))||i.id===this.selected_word.id)&&(s=i.getFirstEmptyCell()||i.getFirstCell(),this.setActiveWord(i),this.setActiveCell(s),this.renderCells(),!0)}.bind(this);switch(t){case"up":for(e=l-1;0<=e;e--)if(r(this.getCell(o,e)))return;break;case c:for(e=l+1;e<=this.grid_height;e++)if(r(this.getCell(o,e)))return;break;case n:for(e=o-1;0<=e;e--)if(r(this.getCell(e,l)))return;break;case d:for(e=o+1;e<=this.grid_width;e++)if(r(this.getCell(e,l)))return}}},O.prototype.moveToNextWord=function(t){if(this.selected_word){var e,i=t?this.active_clues.getPreviousWord(this.selected_word):this.active_clues.getNextWord(this.selected_word);i&&(e=i.getFirstEmptyCell()||i.getFirstCell(),this.setActiveWord(i),this.setActiveCell(e),this.renderCells())}},O.prototype.moveToFirstCell=function(t){if(this.selected_word){var e=t?this.selected_word.getLastCell():this.selected_word.getFirstCell();e&&(this.setActiveCell(e),this.renderCells())}},O.prototype.moveSelectionBy=function(t,e,i){var s,o,l;if(this.selected_cell){if(s=this.selected_cell.x+t,o=this.selected_cell.y+e,!(l=this.getCell(s,o)))return;if(l.empty)return t<0?t--:0<t?t++:e<0?e--:0<e&&e++,void this.moveSelectionBy(t,e,!0);this.selected_word.hasCell(s,o)||(this.inactive_clues.getMatchingWord(l.x,l.y)==this.inactive_clues.getMatchingWord(this.selected_cell.x,this.selected_cell.y)&&null!==this.inactive_clues.getMatchingWord(l.x,l.y)&&(this.changeActiveClues(),this.selected_cell.letter||(l=this.selected_cell)),this.setActiveWord(this.active_clues.getMatchingWord(l.x,l.y))),this.setActiveCell(l),this.renderCells()}},O.prototype.mouseEnteredClue=function(t){var e=$(t.currentTarget);this.hilited_word=this.words[e.data("word")],this.renderCells()},O.prototype.mouseLeftClue=function(){this.hilited_word=null,this.renderCells()},O.prototype.clueClicked=function(t){var e=$(t.currentTarget),i=this.words[e.data("word")],s=i.getFirstEmptyCell()||i.getFirstCell();s&&(this.setActiveWord(i),this.active_clues.id!==e.data("clues")&&this.changeActiveClues(),this.setActiveCell(s),this.renderCells())},O.prototype.showNotepad=function(){alert(this.notepad)},O.prototype.openSettings=function(){this.settings.addClass("open"),this.settings.find("div.cw-color-hover input").val(this.config.color_hover),this.settings.find("div.cw-color-hover span.cw-color-preview").css({background:this.config.color_hover}),this.settings.find("div.cw-color-selected input").val(this.config.color_selected),this.settings.find("div.cw-color-selected span.cw-color-preview").css({background:this.config.color_selected}),this.settings.find("div.cw-color-word input").val(this.config.color_word),this.settings.find("div.cw-color-word span.cw-color-preview").css({background:this.config.color_word}),this.settings.find("div.cw-color-hilite input").val(this.config.color_hilite),this.settings.find("div.cw-color-hilite span.cw-color-preview").css({background:this.config.color_hilite}),this.config.cell_size?(this.settings.find("div.cw-cell-size input[type=text]").removeAttr("disabled"),this.settings.find("div.cw-cell-size input[type=text]").val(this.config.cell_size),this.settings.find("div.cw-cell-size input[type=checkbox]").prop("checked",!1)):(this.settings.find("div.cw-cell-size input[type=text]").prop("disabled",!0),this.settings.find("div.cw-cell-size input[type=checkbox]").prop("checked",!0)),this.settings.find("div.cw-skip-filled input[type=checkbox]").prop("checked",this.config.skip_filled_letters),this.settings_open=!0},O.prototype.closeSettings=function(){localStorage.setItem("crossword_nexus_settings","{}"),this.settings.removeClass("open"),this.settings_open=!1,this.hidden_input.focus()},O.prototype.settingChanged=function(t){var e=$(t.currentTarget),i=e.val();i.match(/#[0-9a-fA-F]{6}/)&&e.siblings("span.cw-color-preview").css({background:i})},O.prototype.settingSizeAuto=function(t){var e=$(t.currentTarget),i=e.parent().siblings("input.cw-input-size");e.prop("checked")?(i.prop("disabled",!0),i.val("")):i.removeAttr("disabled")},O.prototype.saveSettings=function(t){var e;(e=this.settings.find("div.cw-color-hover input").val()).match(/#[0-9a-fA-F]{6}/)&&(this.config.color_hover=e),(e=this.settings.find("div.cw-color-selected input").val()).match(/#[0-9a-fA-F]{6}/)&&(this.config.color_selected=e),(e=this.settings.find("div.cw-color-word input").val()).match(/#[0-9a-fA-F]{6}/)&&(this.config.color_word=e),(e=this.settings.find("div.cw-color-hilite input").val()).match(/#[0-9a-fA-F]{6}/)&&(this.config.color_hilite=e),(e=this.settings.find("div.cw-cell-size input[type=checkbox]").prop("checked"))?this.config.cell_size=null:(e=this.settings.find("div.cw-cell-size input.cw-input-size").val(),this.config.cell_size=Math.max(10,Math.min(100,Number(e)))),this.config.skip_filled_letters=this.settings.find("div.cw-skip-filled input[type=checkbox]").prop("checked"),this.closeSettings(),this.renderCells(),this.hidden_input.focus(),t.preventDefault(),t.stopPropagation()},O.prototype.openReveal=function(){this.reveal_button.addClass("open")},O.prototype.closeReveal=function(){this.reveal_button.removeClass("open")},O.prototype.toggleReveal=function(){this.reveal_button.toggleClass("open")},O.prototype.openCheck=function(){this.check_button.addClass("open")},O.prototype.closeCheck=function(){this.check_button.removeClass("open")},O.prototype.toggleCheck=function(){this.check_button.toggleClass("open")},O.prototype.openFile=function(){this.file_button.addClass("open")},O.prototype.closeFile=function(){this.file_button.removeClass("open")},O.prototype.toggleFile=function(){this.file_button.toggleClass("open")},O.prototype.check_reveal=function(t,e,i){var s=[];switch(t){case"letter":this.selected_cell&&(s=[this.selected_cell]);break;case"word":var o;if(this.selected_word)for(c=0;o=this.selected_word.cells[c];c++)(r=this.selected_word.getCellByCoordinates(o))&&s.push(r);break;case"puzzle":var l,r;for(c in this.cells)for(l in this.cells[c])r=this.cells[c][l],s.push(r)}for(var c=0;c<s.length;c++)S(s[c].letter)!=S(s[c].solution)&&("reveal"==e?(s[c].letter=s[c].solution,s[c].revealed=!0,s[c].checked=!1):"check"==e&&(s[c].checked=!0));this.renderCells(),"reveal"==e?(this.checkIfSolved(),this.closeReveal()):this.closeCheck(),this.hidden_input.focus(),i.preventDefault(),i.stopPropagation()},O.prototype.savePuzzle=function(t){var e,i,s={cell_size:this.cell_size,top_text_height:this.top_text_height,bottom_text_height:this.bottom_text_height,grid_width:this.grid_width,grid_height:this.grid_height,bottom_text:this.bottom_text.html(),top_clues:{id:this.clues_top.id,title:this.clues_top.title,clues:this.clues_top.clues,words_ids:this.clues_top.words_ids},bottom_clues:{id:this.clues_bottom.id,title:this.clues_bottom.title,clues:this.clues_bottom.clues,words_ids:this.clues_bottom.words_ids},words:{},cells:this.cells};for(e in this.words)this.words.hasOwnProperty(e)&&(s.words[e]={id:this.words[e].id,cell_ranges:this.words[e].cell_ranges,cells:this.words[e].cells,clue:this.words[e].clue});i=r+(this.config.savegame_name||""),localStorage.setItem(i,JSON.stringify(s)),alert("Crossword saved"),this.closeFile(),t.preventDefault(),t.stopPropagation()},O.prototype.loadPuzzle=function(t){var e,i,s,o;if(i=r+(this.config.savegame_name||""),(s=JSON.parse(localStorage.getItem(i)))&&s.hasOwnProperty("bottom_text")&&s.hasOwnProperty("top_clues")&&s.hasOwnProperty("bottom_clues")&&s.hasOwnProperty("words")&&s.hasOwnProperty("cells")&&s.hasOwnProperty("cell_size")&&s.hasOwnProperty("top_text_height")&&s.hasOwnProperty("bottom_text_height")&&s.hasOwnProperty("grid_width")&&s.hasOwnProperty("grid_height")){for(e in this.cell_size=s.cell_size,this.top_text_height=s.top_text_height,this.bottom_text_height=s.bottom_text_height,this.grid_width=s.grid_width,this.grid_height=s.grid_height,this.bottom_text.html(s.bottom_text),this.selected_cell=null,this.selected_word=null,this.words={},s.words)s.words.hasOwnProperty(e)&&(this.words[e]=new B(this,s.words[e]));if(this.cells=s.cells,x=!1,this.clues_top=new W(this,s.top_clues),this.clues_bottom=new W(this,s.bottom_clues),x)return void this.error("Error loading savegame - probably corrupted");this.renderClues(this.clues_top,this.clues_top_container),this.renderClues(this.clues_bottom,this.clues_bottom_container),this.active_clues=null,this.inactive_clues=null,this.changeActiveClues(),o=this.active_clues.getFirstWord(),this.setActiveWord(o),this.setActiveCell(o.getFirstCell()),this.renderCells(),alert("Crossword loaded")}else alert("No saved game found");this.closeFile(),t.preventDefault(),t.stopPropagation()},O.prototype.printPuzzle=function(t){if("undefined"!=typeof jsPDF){var e="puzzle.pdf";this.title&&(e=this.title.replace(/[^a-z0-9]/gi,"_").toLowerCase()+".pdf");var f={margin:20,title_pt:null,author_pt:null,copyright_pt:8,num_columns:null,column_padding:10,gray:.4,under_title_spacing:20,max_clue_pt:14,min_clue_pt:5,grid_padding:5,outfile:e,line_width:.3,bar_width:2};f.num_columns||(f.num_columns=17<=this.grid_width?4:3);var i,s=Math.max(f.title_pt,f.author_pt),o=f.margin,l=[];for(var r in this.clues_top.clues)if(this.clues_top.clues.hasOwnProperty(r)){var c=this.clues_top.clues[r].number.toString()+". "+(k=this.clues_top.clues[r].text.replace(/(<([^>]+)>)/gi,"").trim());if(0==r){var n=this.clues_top.title.replace(/(<([^>]+)>)/gi,"").trim();l.push(n+"\n"+c)}else l.push(c)}l.push("");var h=[];for(var r in this.clues_bottom.clues)if(this.clues_bottom.clues.hasOwnProperty(r)){c=this.clues_bottom.clues[r].number.toString()+". "+(k=this.clues_bottom.clues[r].text.replace(/(<([^>]+)>)/gi,"").trim());if(0==r){var d=this.clues_bottom.title.replace(/(<([^>]+)>)/gi,"").trim();h.push(d+"\n"+c)}else h.push(c)}for(var a=(612-2*o-(f.num_columns-1)*f.column_padding)/f.num_columns,u=612-2*o-a-f.column_padding,p=612-o-u,v=792-o-u-f.copyright_pt,_=f.max_clue_pt,g=!0;g;){var w=_/3;(i=new jsPDF("portrait","pt","letter")).setFontSize(_),i.setLineWidth(f.line_width);for(var m=o,b=o+s+f.under_title_spacing+_+w,y=0,x=[l,h],z=0;z<x.length;z++){var C=x[z];for(r=0;r<C.length;r++){var k=C[r],P=0==y?792-o-f.copyright_pt:v-f.grid_padding,A=i.splitTextToSize(k,a);if(""!=k||b!=o+s+f.under_title_spacing+_+w){b+(A.length-1)*(_+w)>P&&(y+=1,P=v-f.grid_padding,m=o+y*(a+f.column_padding),b=o+s+f.under_title_spacing+_+w);for(var F=0;F<A.length;F++){0==r&&0==F?i.setFontType("bold"):i.setFontType("normal");var T=A[F];i.text(m,b,T),P<(b+=_+w)&&(m=o+(y+=1)*(a+f.column_padding),b=o+s+f.under_title_spacing+_+w)}}}}_==f.min_clue_pt?g=!1:y>f.num_columns-1?_-=.2:g=!1}if(f.author_pt||(f.author_pt=f.title_pt),!f.title_pt){f.title_pt=12;for(var $=!0;$;){var S=this.title+"asdfasdf"+this.author;i.setFontSize(f.title_pt).setFontType("bold"),1==(A=i.splitTextToSize(S,612)).length?$=!1:f.title_pt-=1}f.author_pt=f.title_pt}var N=o,O=612-o,W=o+s;i.setFontSize(f.title_pt),i.setFontType("bold"),i.text(N,W,this.title),i.setFontSize(f.author_pt),i.text(O,W,this.author,null,null,"right"),i.setFontType("normal");var B=612-o,E=792-o;i.setFontSize(f.copyright_pt),i.text(B,E,this.copyright,null,null,"right");var M={grid_letters:!0,grid_numbers:!0,x0:p,y0:v,grid_size:u,gray:f.gray},j=Math.max(this.grid_width,this.grid_height),L=M.grid_size/j;for(var R in this.cells)for(var D in this.cells[R]){var I=this.cells[R][D],J=(r=D-1,F=R-1,M.x0+F*L),Z=M.y0+r*L,H=(this.grid_width,!1),X=I.letter;I.empty&&(H=!0,X=""),M.grid_letters||(X="");var K=I.number;M.grid_numbers||(K=""),G(i,J,Z,L,K,X,H,I.shape,I.color,I.bar)}i.save(f.outfile)}else alert("Printing is disabled.  jsPDF is not defined.  Contact the webmaster.");function G(t,e,i,s,o,l,r,c,n,h){var d=r?"F":"",a=s/4;if(n){d="F";var u=function(t){t=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(t,e,i,s){return e+e+i+i+s+s});var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}(n);t.setFillColor(u.r,u.g,u.b),t.rect(e,i,s,s,d),t.rect(e,i,s,s,"")}else t.setFillColor(M.gray.toString()),t.rect(e,i,s,s,d);o||(o=""),t.setFontSize(a),t.text(e+1+1,i+1+a,o),l||(l="");var p=l.length;if(t.setFontSize(s/(1.5+.5*p)),t.text(e+s/2,i+.8*s,l,null,null,"center"),c&&t.circle(e+s/2,i+s/2,s/2),h){var v={top:[e,i],left:[e,i],right:[e+s,i+s],bottom:[e+s,i+s]},_={top:[e+s,i],left:[e,i+s],right:[e+s,i],bottom:[e,i+s]};for(var g in h)h.hasOwnProperty(g)&&h[g]&&(t.setLineWidth(f.bar_width),t.line(v[g][0],v[g][1],_[g][0],_[g][1]),t.setLineWidth(f.line_width))}}},O.prototype.toggleTimer=function(){var e,i,s=this.timer_button;function t(){var t=((i=((k+=1)-(e=k%60))/60)?9<i?i:"0"+i:"00")+":"+(9<e?e:"0"+e);s.html(t),o()}function o(){l=setTimeout(t,1e3)}this.timer_running?(clearTimeout(l),s.removeClass("running"),this.timer_running=!1,this.hidden_input.focus()):(this.timer_running=!0,s.addClass("running"),this.hidden_input.focus(),o())};var W=function(t,e){this.id="",this.title="",this.clues=[],this.clues_container=null,this.words_ids=[],this.crossword=t,e&&(e.hasOwnProperty("id")&&e.hasOwnProperty("title")&&e.hasOwnProperty("clues")&&e.hasOwnProperty("words_ids")?(this.id=e.id,this.title=e.title,this.clues=e.clues,this.words_ids=e.words_ids):x=!0)};W.prototype.fromJPZ=function(t){var e,i,s=t.getElementsByTagName("title")[0],o=t.getElementsByTagName("clue");for(this.title=T(s),e=0;i=o[e];e++){var l=i.getAttribute("word"),r=this.crossword.words[l],c={word:l,number:i.getAttribute("number"),text:T(i)};this.clues.push(c),r.clue=c,this.words_ids.push(l)}},W.prototype.getFirstWord=function(){return this.words_ids.length?this.crossword.words[this.words_ids[0]]:null},W.prototype.getMatchingWord=function(t,e){var i,s,o;for(i=0;s=this.words_ids[i];i++)if((o=this.crossword.words.hasOwnProperty(s)?this.crossword.words[s]:null)&&0<=o.cells.indexOf(t+"-"+e))return o;return null},W.prototype.markActive=function(t,e,i){var s,o,l,r=i?"passive":"active",c=this.getMatchingWord(t,e);this.clues_container.find("div.cw-clue.active").removeClass("active"),this.clues_container.find("div.cw-clue.passive").removeClass("passive"),c&&((s=this.clues_container.find("div.cw-clue.word-"+c.id)).addClass(r),o=s.position().top,l=s.outerHeight(!0),(o<0||o+l>this.clues_container.height())&&this.clues_container.animate({scrollTop:this.clues_container.scrollTop()+o},150))},W.prototype.getNextWord=function(t){var e=null,i=this.words_ids.indexOf(t.id);return i<this.words_ids.length-1&&(e=this.crossword.words[this.words_ids[i+1]]),e},W.prototype.getPreviousWord=function(t){var e=null,i=this.words_ids.indexOf(t.id);return 0<i&&(e=this.crossword.words[this.words_ids[i-1]]),e};var B=function(t,e){this.id="",this.cell_ranges=[],this.cells=[],this.clue={},this.crossword=t,e&&(e.hasOwnProperty("id")&&e.hasOwnProperty("cell_ranges")&&e.hasOwnProperty("cells")&&e.hasOwnProperty("clue")?(this.id=e.id,this.cell_ranges=e.cell_ranges,this.cells=e.cells,this.clue=e.clue):x=!0)};return B.prototype.fromJPZ=function(t){if(t){var e,i,s=t.getAttribute("id"),o=t.getAttribute("x"),l=t.getAttribute("y");if(this.id=s,o&&l)this.cell_ranges.push({x:o,y:l});else{var r=t.getElementsByTagName("cells");for(e=0;i=r[e];e++)o=i.getAttribute("x"),l=i.getAttribute("y"),this.cell_ranges.push({x:o,y:l})}this.parseRanges()}},B.prototype.parseRanges=function(){var t,e,i;for(this.cells=[],t=0;i=this.cell_ranges[t];t++){var s,o,l,r,c,n,h=i.x.split("-"),d=i.y.split("-");if(1<h.length)for(l=Number(h[0]),r=Number(h[1]),o=d[0],e=l;l<r?e<=r:r<=e;l<r?e++:e--)this.cells.push(e+"-"+o);else if(1<d.length)for(s=h[0],c=Number(d[0]),n=Number(d[1]),e=c;c<n?e<=n:n<=e;c<n?e++:e--)this.cells.push(s+"-"+e);else s=h[0],o=d[0],this.cells.push(s+"-"+o)}},B.prototype.hasCell=function(t,e){return 0<=this.cells.indexOf(t+"-"+e)},B.prototype.getFirstEmptyCell=function(t,e){var i,s,o,l=0;for(t&&e&&(l=Math.max(0,this.cells.indexOf(t+"-"+e)))==this.cells.length-1&&(l=0),i=l;o=this.cells[i];i++)if((s=this.getCellByCoordinates(o))&&!s.letter)return s;if(0<l)for(i=0;i<l;i++)if((s=this.getCellByCoordinates(this.cells[i]))&&!s.letter)return s;return null},B.prototype.getFirstCell=function(){var t=null;return this.cells.length&&(t=this.getCellByCoordinates(this.cells[0])),t},B.prototype.getLastCell=function(){var t=null;return this.cells.length&&(t=this.getCellByCoordinates(this.cells[this.cells.length-1])),t},B.prototype.getNextCell=function(t,e){var i=this.cells.indexOf(t+"-"+e),s=null;return i<this.cells.length-1&&(s=this.getCellByCoordinates(this.cells[i+1])),s},B.prototype.getPreviousCell=function(t,e){var i=this.cells.indexOf(t+"-"+e),s=null;return 0<i&&(s=this.getCellByCoordinates(this.cells[i-1])),s},B.prototype.getCellByCoordinates=function(t){var e,i,s,o;return 2===(e=t.split("-")).length&&(i=e[0],s=e[1],o=this.crossword.getCell(i,s))?o:null},B.prototype.solve=function(){var t,e,i;for(t=0;e=this.cells[t];t++)(i=this.getCellByCoordinates(e))&&(i.letter=i.solution)},"function"==typeof define&&define.amd&&define("CrosswordNexus",[],function(){return N}),t&&(s.CrosswordNexus=N),N});
